<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TuxTrader Long‑Term Analyzer</title>

  <!-- Tailwind (dark mode via class) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            orange: { 500: '#ff6200', 600: '#ff4d00' }
          }
        }
      }
    };
    // Persisted dark mode preference
    (function(){
      const pref = localStorage.theme;
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.classList.toggle('dark',
        pref ? pref === 'dark' : prefersDark
      );
    })();
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* subtle card glow */
    .card { box-shadow: 0 10px 30px rgba(0,0,0,.15); }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

  <!-- Navbar -->
  <nav class="bg-orange-500 text-white">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-chart-line"></i>
        <span class="font-semibold">CryptoBot — Long‑Term Analyzer</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggleTheme" class="border border-white/50 rounded px-3 py-1 hover:bg-white hover:text-orange-600 transition">
          <i class="fa-solid fa-moon"></i> <span class="ml-1">Theme</span>
        </button>
        <a href="/health" target="_blank" class="border border-white/50 rounded px-3 py-1 hover:bg-white hover:text-orange-600 transition">
          <i class="fa-solid fa-heart-pulse"></i> Health
        </a>
      </div>
    </div>
  </nav>

  <!-- Controls -->
  <section class="container mx-auto px-4 mt-6">
    <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
      <div class="grid md:grid-cols-4 gap-4">
        <div>
        <label class="block text-sm mb-1" data-help="Pick from enabled coins in config.json.">Symbol</label>
        <select id="symbol" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none"></select>
        <div class="mt-2 flex items-center gap-2">
            <input id="applyDefaults" type="checkbox" class="accent-orange-500" />
            <label for="applyDefaults" class="text-xs opacity-80" data-help="If enabled, use this coin's RSI/MACD/precision from config.json for charts.">Apply coin defaults</label>
        </div>
        </div>
        <div>
          <label class="block text-sm mb-1" data-help="Bucket size for averaging prices. Larger buckets = smoother & faster. 'raw' uses every tick.">Aggregation</label>
          <select id="agg" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none">
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
            <option value="15min">15min</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1" data-help="Start of the analysis window. Date-only uses 00:00 UTC that day.">Start</label>
          <input id="start" type="date" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
        </div>
        <div>
          <label class="block text-sm mb-1" data-help="Exclusive end of the window. Leave empty to include the most recent data.">End (optional)</label>
          <input id="end" type="date" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <div class="col-span-2 grid grid-cols-6 gap-3">
          <div>
            <label class="block text-xs mb-1" data-help="Simple moving averages. Comma-separated window lengths in bars (match your aggregation).">SMA</label>
            <input id="sma" type="text" placeholder="50,200" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">E.g., 50,200 → two SMAs using current aggregation.</p>
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Exponential moving averages (more reactive). Comma-separated windows in bars.">EMA</label>
            <input id="ema" type="text" placeholder="20,50" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Lookback length for RSI. Common values: 14; <30 oversold, >70 overbought.">RSI period</label>
            <input id="rsi" type="number" value="14" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Lookback for Bollinger Bands. Typical: 20.">BB period</label>
            <input id="bbp" type="number" value="20" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Standard deviation multiplier for Bollinger Bands. Common: 2.0">BB std</label>
            <input id="bbs" type="number" step="0.1" value="2.0" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div class="flex items-center gap-2 mt-6">
            <input id="showPivots" type="checkbox" class="accent-orange-500" checked />
            <label for="showPivots" class="text-sm" data-help="Marks potential support/resistance points (local highs/lows) on the price chart.">Show pivots</label>
          </div>
        </div>
      </div>
      <div class="grid md:grid-cols-4 gap-4 mt-4">

        <!-- Drawdown params -->
        <div class="col-span-2 grid grid-cols-4 gap-3 mt-4">
          <div>
            <label class="block text-xs mb-1" data-help="Minimum drawdown from the most recent peak to start tracking a drop event (e.g., 10% = -10%).">Min drop %</label>
            <input id="ddMin" type="number" step="0.1" value="10" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="How close to the prior peak counts as 'recovered' (e.g., 0.5% means recover within 0.5% of the peak).">Recovery tolerance %</label>
            <input id="ddTol" type="number" step="0.1" value="0" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
            </div>
            <div>
                <label class="block text-xs mb-1" data-help="How many days to look ahead for recovery after a drawdown.">Lookahead days</label>
                <input id="ddLook" type="number" value="60" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
            </div>
            <div>
                <label class="block text-xs mb-1" data-help="Window after recovery to measure any rally beyond the old peak.">Overshoot window (days)</label>
                <input id="ddOver" type="number" value="14" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
            </div>
        </div>

        <!-- Optimal Drop sweep params -->
        <div class="col-span-2 grid grid-cols-5 gap-3 mt-4">
          <div>
            <label class="block text-xs mb-1" data-help="Take-profit goal used to evaluate drop thresholds (e.g., +5%, +10%).">Target profit %</label>
            <input id="odTarget" type="number" step="0.1" value="5" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Lower bound of drop thresholds to scan (e.g., 5% = -5%).">Drop min %</label>
            <input id="odMin" type="number" step="0.1" value="5" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Upper bound of drop thresholds to scan (e.g., 40% = -40%). Rare but powerful dips.">Drop max %</label>
            <input id="odMax" type="number" step="0.1" value="40" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Resolution of the scan between min and max (smaller step = finer scan, slower).">Drop step %</label>
            <input id="odStep" type="number" step="0.1" value="1" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Max days a trade has to hit the target before we count it as a timeout.">Lookahead days</label>
            <input id="odLook" type="number" value="60" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="How to pick the ‘best’ drop: Expected %/yr (throughput), Wins/yr (frequency), Success rate (reliability), or SR/Median days (fast & steady).">Score by</label>
            <select id="odScore" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none">
            <option value="expected_return_per_year" selected>Expected %/yr</option>
            <option value="successes_per_year">Wins/yr</option>
            <option value="success_rate">Success rate</option>
            <option value="sr_over_median_days">SR / Median days</option>
            </select>
          </div>
          <div>
            <label class="block text-xs mb-1" data-help="Window to find the recent peak used to compute today's drawdown for the buy/wait recommendation.">Lookback (days)</label>
            <input id="recoPeakWin" type="number" value="180" class="w-full px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 focus:outline-none" />
          </div>
        </div>
        </div>

        
        <div class="md:col-span-2 flex items-end gap-3">
          <button id="loadBtn" class="px-4 py-2 rounded bg-orange-500 hover:bg-orange-600 text-white font-semibold transition">
            <i class="fa-solid fa-download mr-1"></i> Load data
          </button>
          <a id="csvBtn" href="#" target="_blank" class="px-4 py-2 rounded border border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white transition">
            <i class="fa-solid fa-file-csv mr-1"></i> Export CSV
          </a>
          <div id="busy" class="hidden text-sm opacity-80">
            <i class="fa-solid fa-compact-disc fa-spin mr-2" data-help="Download the aggregated price series as CSV for external analysis."></i> fetching…
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPI cards -->
  <section class="container mx-auto px-4 mt-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <div class="text-sm opacity-70">Price</div>
        <div id="kpiPrice" class="text-2xl font-semibold mt-1">—</div>
        <div id="kpiDist200" class="text-xs mt-1 opacity-80">Dist to SMA200: —</div>
      </div>
      <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <div class="text-sm opacity-70">Volatility (30)</div>
        <div id="kpiVol" class="text-2xl font-semibold mt-1">—</div>
        <div id="kpiDD" class="text-xs mt-1 opacity-80">Max drawdown: —</div>
      </div>
      <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <div class="text-sm opacity-70">Seasonality tilt</div>
        <div id="kpiSeason" class="text-2xl font-semibold mt-1">—</div>
        <div class="text-xs mt-1 opacity-80">Avg best hour/day</div>
      </div>
    </div>
  </section>

  <!-- Charts -->
  <section class="container mx-auto px-4 mt-6">
    <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
      <h3 class="font-semibold mb-3">Price & Indicators</h3>
      <canvas id="priceChart" height="120"></canvas>
    </div>
    <div class="grid md:grid-cols-2 gap-4 mt-4">
      <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <h3 class="font-semibold mb-3">MACD</h3>
        <canvas id="macdChart" height="120"></canvas>
      </div>
      <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <h3 class="font-semibold mb-3">RSI</h3>
        <canvas id="rsiChart" height="120"></canvas>
      </div>
    </div>
  </section>

  <!-- Seasonality heatmaps -->
  <section class="container mx-auto px-4 my-6">
    <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
      <h3 class="font-semibold mb-4">Seasonality</h3>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <div class="text-sm mb-2 opacity-80">Day of week (avg return)</div>
          <div id="dow" class="grid grid-cols-7 gap-1"></div>
        </div>
        <div>
          <div class="text-sm mb-2 opacity-80">Hour of day (avg return)</div>
          <div id="hour" class="grid grid-cols-12 gap-1"></div>
        </div>
      </div>
    </div>
  </section>

    <!-- Drawdown Analysis -->
    <section class="container mx-auto px-4 my-6">
    <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Drop → Recovery Analysis</h3>
        <div class="text-xs opacity-70" id="ddParamsNote">—</div>
        </div>

        <!-- KPIs -->
        <div class="grid md:grid-cols-4 gap-4 mb-4">
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Events</div>
            <div id="ddKpiEvents" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Success rate</div>
            <div id="ddKpiSuccess" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Avg recovery (days)</div>
            <div id="ddKpiAvg" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Worst recovery (days)</div>
            <div id="ddKpiWorst" class="text-xl font-semibold">—</div>
        </div>
        </div>

        <!-- Table -->
        <div class="overflow-auto">
        <table class="min-w-full text-sm">
            <thead class="text-left border-b border-gray-200 dark:border-gray-700">
            <tr>
                <th class="py-2 pr-4">Start (peak)</th>
                <th class="py-2 pr-4">Trough</th>
                <th class="py-2 pr-4">Recovery</th>
                <th class="py-2 pr-4 text-right">Drop %</th>
                <th class="py-2 pr-4 text-right">Recovery days</th>
                <th class="py-2 pr-4 text-right">Overshoot %</th>
            </tr>
            </thead>
            <tbody id="ddTable" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
        </table>
        </div>
    </div>
    </section>

    <!-- Trade Recommendation -->
    <section class="container mx-auto px-4 my-6">
    <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Recommendation (based on history)</h3>
        <div class="text-xs opacity-70" id="recoParamsNote">—</div>
        </div>

        <div class="grid md:grid-cols-4 gap-4">
        <div class="md:col-span-1">
            <div id="recoBadge" class="text-center rounded-lg p-6 font-semibold">
            —
            </div>
        </div>
        <div class="md:col-span-3 grid sm:grid-cols-3 gap-4">
            <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Current drawdown</div>
            <div id="recoDD" class="text-xl font-semibold">—</div>
            <div class="text-xs opacity-70 mt-1">Peak: <span id="recoPeak">—</span></div>
            <div class="text-xs opacity-70">Price: <span id="recoPrice">—</span></div>
            </div>
            <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Recommended drop</div>
            <div id="recoDrop" class="text-xl font-semibold">—</div>
            <div class="text-xs opacity-70 mt-1">Buy @ ~<span id="recoBuyPx">—</span></div>
            <div class="text-xs opacity-70">Gap to signal: <span id="recoGap">—</span></div>
            </div>
            <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Timing (est.)</div>
            <div id="recoWait" class="text-xl font-semibold">—</div>
            <div class="text-xs opacity-70 mt-1">Median days to +target: <span id="recoMed">—</span></div>
            <div class="text-xs opacity-70">Success rate: <span id="recoSR">—</span></div>
            </div>
        </div>
        </div>
    </div>
    </section>

    <!-- Optimal Buy Zone -->
    <section class="container mx-auto px-4 my-6">
    <div class="card rounded-xl bg-white dark:bg-gray-800 p-4">
        <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Optimal Buy Zone (for target)</h3>
        <div class="text-xs opacity-70" id="odParamsNote">—</div>
        </div>

        <!-- KPIs -->
        <div class="grid md:grid-cols-5 gap-4 mb-4">
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Recommended drop</div>
            <div id="odBestDrop" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Success rate</div>
            <div id="odBestSR" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Median days</div>
            <div id="odBestMed" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">P90 days</div>
            <div id="odBestP90" class="text-xl font-semibold">—</div>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Entries (best)</div>
            <div id="odBestEntries" class="text-xl font-semibold">—</div>
        </div>
        </div>

        <div class="card rounded bg-white/50 dark:bg-gray-900/30 p-3">
        <canvas id="optChart" height="120"></canvas>
        </div>
        <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Signals / year</div>
            <div id="odBestSigYr" class="text-xl font-semibold">—</div>
            </div>
            <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Wins / year</div>
            <div id="odBestWinYr" class="text-xl font-semibold">—</div>
            </div>
            <div class="rounded bg-gray-50 dark:bg-gray-700 p-3">
            <div class="text-xs opacity-70">Expected % / year (at target)</div>
            <div id="odBestExpYr" class="text-xl font-semibold">—</div>
        </div>
    </div>
    </section>

  <script>
    // --- Theme toggle ---
    document.getElementById('toggleTheme').onclick = () => {
      const el = document.documentElement;
      const next = !el.classList.contains('dark');
      el.classList.toggle('dark', next);
      localStorage.theme = next ? 'dark' : 'light';
      applyChartTheme();
      [priceChart, macdChart, rsiChart, optChart].forEach(ch => ch && ch.update());
    };

    function applyChartTheme() {
        const dark = document.documentElement.classList.contains('dark');
        Chart.defaults.color = dark ? '#e5e7eb' /* text-gray-200 */ : '#374151' /* text-gray-700 */;
        Chart.defaults.borderColor = dark ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.12)'; // grid/ticks
        Chart.defaults.datasets.line.spanGaps = true;
        Chart.defaults.elements.point.radius = 0;
    }
    applyChartTheme();

    function initHelpTips(){
    document.querySelectorAll('[data-help]').forEach(label => {
        // wrap a help icon + tooltip after the label text
        const text = label.getAttribute('data-help') || '';
        const wrap = document.createElement('span');
        wrap.className = 'relative inline-flex items-center group align-middle ml-1';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'text-xs text-gray-400 dark:text-gray-300 hover:text-gray-600 dark:hover:text-gray-100 focus:outline-none';
        btn.setAttribute('aria-label', 'Help');
        btn.innerHTML = '<i class="fa-regular fa-circle-question"></i>';

        const tip = document.createElement('div');
        tip.role = 'tooltip';
        tip.className = [
        'absolute z-40 hidden group-hover:block group-focus-within:block',
        'top-full left-1/2 -translate-x-1/2 mt-2 w-64',
        'rounded px-3 py-2 text-xs shadow-lg',
        'bg-gray-900 text-white dark:bg-gray-800'
        ].join(' ');
        tip.textContent = text;

        // optional little arrow
        const arrow = document.createElement('div');
        arrow.className = 'absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 rotate-45 bg-gray-900 dark:bg-gray-800';
        tip.appendChild(arrow);

        wrap.appendChild(btn);
        wrap.appendChild(tip);
        label.appendChild(wrap);
    });
    }
    window.addEventListener('DOMContentLoaded', initHelpTips);

    async function fetchRecommendation(params) {
        const url = buildURL('/api/lt/recommendation', params);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Recommendation request failed');
        return res.json();
    }
    function money(x){ return (x==null)?'—':Number(x).toLocaleString(undefined,{maximumFractionDigits:4}); }

    // Coin configuration
    let COIN_CFG = null;

    async function loadCoinConfig() {
        if (COIN_CFG) return COIN_CFG;
        const res = await fetch('/api/config/coins');
        if (!res.ok) throw new Error('Failed to load coin config');
        COIN_CFG = await res.json();
        return COIN_CFG;
        }

        function populateSymbolSelect(cfg) {
        const sel = document.getElementById('symbol');
        sel.innerHTML = '';
        const enabled = cfg.enabled || [];
        if (!enabled.length) {
            const opt = document.createElement('option');
            opt.value = 'ETH';
            opt.textContent = 'ETH';
            sel.appendChild(opt);
            return;
            }
        enabled.forEach(sym => {
            const opt = document.createElement('option');
            opt.value = sym;
            opt.textContent = sym;
            sel.appendChild(opt);
        });
        }

        function coinPrec(symbol) {
        const c = COIN_CFG?.coins?.[symbol];
        return c?.precision?.price ?? 4;
        }

        function moneyPrec(x, symbol) {
        if (x == null) return '—';
        const d = coinPrec(symbol);
        return Number(x).toLocaleString(undefined, { maximumFractionDigits: d });
        }

    // --- Chart instances ---
    let priceChart, macdChart, rsiChart, optChart;

    function makeLine(ctx, label, labels, datasets, yTitle='') {
    if (ctx._chart) { ctx._chart.destroy(); }
    const p = palette();
    const chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { position: 'bottom', labels: { color: p.text } },
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${(+c.parsed.y).toLocaleString()}` } }
        },
        scales: {
            x: { ticks: { color: p.text }, grid: { color: p.grid } },
            y: { ticks: { color: p.text }, grid: { color: p.grid }, title: { display: !!yTitle, text: yTitle, color: p.text } }
        },
        elements: { line: { tension: 0.2 } }
        }
    });
    ctx._chart = chart;
    return chart;
    }

    function parseList(val) {
      if (!val) return [];
      return val.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
    }

    function buildURL(base, params) {
      const usp = new URLSearchParams();
      Object.entries(params).forEach(([k, v]) => {
        if (v === undefined || v === null || v === '' ) return;
        if (Array.isArray(v)) v.forEach(x => usp.append(k, x));
        else usp.append(k, v);
      });
      return `${base}?${usp.toString()}`;
    }

    function negateNull(x){ return (x===null || x===undefined) ? null : Number(x); }

    function updateKPIs(rows) {
      if (!rows.length) {
        document.getElementById('kpiPrice').textContent = '—';
        document.getElementById('kpiDist200').textContent = 'Dist to SMA200: —';
        document.getElementById('kpiVol').textContent = '—';
        document.getElementById('kpiDD').textContent = 'Max drawdown: —';
        return;
      }
      const last = rows[rows.length-1];
      const price = last.price ?? null;
      const sma200 = last.SMA_200 ?? null;
      const vol = last.VOL_30 ?? null;
      const dd = last.DRAWDOWN ?? null;

      document.getElementById('kpiPrice').textContent = price ? price.toFixed(4) : '—';
      if (sma200 && price) {
        const dist = ((price / sma200) - 1) * 100;
        document.getElementById('kpiDist200').textContent = `Dist to SMA200: ${dist.toFixed(2)}%`;
      } else {
        document.getElementById('kpiDist200').textContent = 'Dist to SMA200: —';
      }
      document.getElementById('kpiVol').textContent = vol ? (vol*100).toFixed(2) + '%' : '—';
      document.getElementById('kpiDD').textContent = dd ? (dd*100).toFixed(2) + '%' : '—';
    }

    function colorFor(value, min, max) {
      // value in [-x, +x] -> red..gray..green
      if (value === null || value === undefined) return 'rgba(128,128,128,.35)';
      const clamped = Math.max(min, Math.min(max, value));
      const t = (clamped - min) / (max - min || 1); // 0..1
      const hue = 0 + 120*t; // red(0) -> green(120)
      return `hsl(${hue}deg 70% 45% / .85)`;
    }

    function renderHeatmap(container, entries, labels, min, max) {
      container.innerHTML = '';
      labels.forEach((lab) => {
        const v = entries[lab] ?? 0;
        const cell = document.createElement('div');
        cell.className = 'text-xs text-center p-2 rounded';
        cell.style.background = colorFor(v*100, min, max);
        cell.title = `${lab}: ${(v*100).toFixed(2)}%`;
        cell.textContent = lab;
        container.appendChild(cell);
      });
    }

    // Format ISO "YYYY-MM-DDTHH:MM:SS(.ms)?" -> "YYYY-MM-DD HH:MM:SS"
    function isoToLabel(iso) {
    if (!iso) return '';
    return iso.slice(0,19).replace('T', ' ');
    }
    function fmtPct(x) {
    return (x === null || x === undefined) ? '—' : (x*100).toFixed(2) + '%';
    }
    function fmtDays(x) {
    return (x === null || x === undefined) ? '—' : (+x).toFixed(2);
    }

    async function fetchDrawdowns(params) {
        const url = buildURL('/api/lt/drawdowns', params);
        const res = await fetch(url);
        if (!res.ok) throw new Error('Drawdowns request failed');
        return res.json();
        }

    function renderDrawdownTable(events) {
    const tbody = document.getElementById('ddTable');
    tbody.innerHTML = '';
    if (!events || !events.length) {
        tbody.innerHTML = `<tr><td class="py-3 opacity-70" colspan="6">No events in range.</td></tr>`;
        return;
    }
    for (const e of events) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td class="py-2 pr-4">${isoToLabel(e.start)}</td>
        <td class="py-2 pr-4">${isoToLabel(e.trough)}</td>
        <td class="py-2 pr-4">${e.recovery ? isoToLabel(e.recovery) : '—'}</td>
        <td class="py-2 pr-4 text-right">${fmtPct(Math.abs(e.drop_pct))}</td>
        <td class="py-2 pr-4 text-right">${fmtDays(e.recovery_days)}</td>
        <td class="py-2 pr-4 text-right">${fmtPct(e.overshoot_pct)}</td>
        `;
        tbody.appendChild(tr);
    }
    }
    function renderDrawdownKPIs(summary) {
    document.getElementById('ddKpiEvents').textContent =
        (summary && summary.events !== undefined) ? summary.events : '—';
    document.getElementById('ddKpiSuccess').textContent =
        (summary && summary.success_rate !== null && summary.success_rate !== undefined)
        ? (summary.success_rate*100).toFixed(1) + '%'
        : '—';
    document.getElementById('ddKpiAvg').textContent =
        (summary && summary.avg_recovery_days !== null && summary.avg_recovery_days !== undefined)
        ? (+summary.avg_recovery_days).toFixed(2)
        : '—';
    document.getElementById('ddKpiWorst').textContent =
        (summary && summary.worst_recovery_days !== null && summary.worst_recovery_days !== undefined)
        ? (+summary.worst_recovery_days).toFixed(2)
        : '—';
    }

    function buildDrawdownMarkerDatasets(labels, priceSeries, events) {
    if (!events?.length) return [];
    const labelToIdx = new Map(labels.map((s,i)=>[s,i]));
    const idxOf = (iso) => labelToIdx.get(isoToLabel(iso)) ?? -1;

    const troughs = new Array(labels.length).fill(null);
    const recovs  = new Array(labels.length).fill(null);

    for (const e of events) {
        const ti = idxOf(e.trough);
        if (ti >= 0) troughs[ti] = priceSeries[ti] ?? null;
        if (e.recovery) {
        const ri = idxOf(e.recovery);
        if (ri >= 0) recovs[ri] = priceSeries[ri] ?? null;
        }
    }

    return [
        {
        label: 'Trough',
        data: troughs,
        showLine: false,
        pointRadius: 6,
        hoverRadius: 7,
        pointStyle: 'triangle',           // ▼
        backgroundColor: 'rgba(220,38,38,0.95)', // red-600
        borderColor: 'rgba(220,38,38,0.95)',
        borderWidth: 0,
        order: 99
        },
        {
        label: 'Recovery',
        data: recovs,
        showLine: false,
        pointRadius: 6,
        hoverRadius: 7,
        pointStyle: 'triangle',           // ▲ (rotated)
        rotation: 180,
        backgroundColor: 'rgba(34,197,94,0.95)', // green-500
        borderColor: 'rgba(34,197,94,0.95)',
        borderWidth: 0,
        order: 99
        }
    ];
    }

    function palette() {
    const dark = document.documentElement.classList.contains('dark');
    return {
        price: '#ff6200',                 // brand orange
        sma:   ['#60a5fa','#a78bfa','#f472b6','#22d3ee'], // blue, violet, pink, cyan
        ema:   ['#34d399','#f59e0b','#ef4444'],           // green, amber, red
        bb:    { upper: '#93c5fd', mid: '#c4b5fd', lower: '#93c5fd' }, // light tints
        macd:  { macd: '#38bdf8', signal: '#fbbf24', hist: dark ? '#94a3b8' : '#64748b' },
        rsi:   '#22d3ee',
        grid:  Chart.defaults.borderColor,
        text:  Chart.defaults.color
    };
    }

    function pctStr(x){ return (x==null)?'—':(x*100).toFixed(1)+'%'; }
    function daysStr(x){ return (x==null)?'—':(+x).toFixed(2); }

    async function fetchOptimalDrop(params) {
    const url = buildURL('/api/lt/optimal_drop', params);
    const res = await fetch(url);
    if (!res.ok) throw new Error('Optimal drop request failed');
    return res.json();
    }

    function renderOptimalKPIs(best) {
        document.getElementById('odBestDrop').textContent = best?.drop_pct!=null ? (best.drop_pct*100).toFixed(1)+'%' : '—';
        document.getElementById('odBestSR').textContent   = best?.success_rate!=null ? (best.success_rate*100).toFixed(1)+'%' : '—';
        document.getElementById('odBestMed').textContent  = best?.median_days!=null ? (+best.median_days).toFixed(2) : '—';
        document.getElementById('odBestP90').textContent  = best?.p90_days!=null ? (+best.p90_days).toFixed(2) : '—';
        document.getElementById('odBestEntries').textContent = best?.entries ?? '—';

        document.getElementById('odBestSigYr').textContent = best?.entries_per_year!=null ? (+best.entries_per_year).toFixed(2) : '—';
        document.getElementById('odBestWinYr').textContent = best?.successes_per_year!=null ? (+best.successes_per_year).toFixed(2) : '—';
        document.getElementById('odBestExpYr').textContent = best?.expected_return_per_year!=null ? ((best.expected_return_per_year)*100).toFixed(1)+'%' : '—';
    }
    function renderOptimalChart(grid) {
    const ctx = document.getElementById('optChart');
    if (optChart) optChart.destroy();

    const p = palette();
    const labels = grid.map(g => (g.drop_pct*100).toFixed(1)); // drop % on x-axis
    const successRate = grid.map(g => g.success_rate!=null ? +(g.success_rate*100).toFixed(2) : null); // %
    const medianDays  = grid.map(g => g.median_days!=null ? +(+g.median_days).toFixed(2) : null);

    optChart = new Chart(ctx, {
        data: {
        labels,
        datasets: [
            {
            type: 'bar',
            label: 'Success rate (%)',
            data: successRate,
            borderColor: p.ema[0],
            backgroundColor: p.ema[0],
            yAxisID: 'yLeft'
            },
            {
            type: 'line',
            label: 'Median days to target',
            data: medianDays,
            borderColor: p.sma[0],
            backgroundColor: 'transparent',
            yAxisID: 'yRight',
            tension: 0.2
            }
        ]
        },
        options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { position: 'bottom', labels: { color: Chart.defaults.color } },
            tooltip: {
            callbacks: {
                title: items => `Drop: ${items[0].label}%`,
                label: c => c.dataset.label.includes('Success') ?
                `${c.dataset.label}: ${c.parsed.y?.toFixed?.(2) ?? c.parsed.y}%` :
                `${c.dataset.label}: ${c.parsed.y}`
            }
            }
        },
        scales: {
            x: { ticks: { color: Chart.defaults.color }, grid: { color: Chart.defaults.borderColor }, title: { display: true, text: 'Drop from peak (%)', color: Chart.defaults.color } },
            yLeft:  { position: 'left',  min: 0, max: 100, ticks: { color: Chart.defaults.color }, grid: { color: Chart.defaults.borderColor }, title: { display: true, text: 'Success rate (%)', color: Chart.defaults.color } },
            yRight: { position: 'right', beginAtZero: true, ticks: { color: Chart.defaults.color }, grid: { drawOnChartArea: false }, title: { display: true, text: 'Median days', color: Chart.defaults.color } }
        }
        }
    });
    }

    function renderRecommendation(recoJson, targetPct, symbol) {
    const sym = symbol ?? document.getElementById('symbol')?.value ?? 'ETH';
    const r = recoJson?.recommendation || null;
    const best = recoJson?.best || null;

    const badge = document.getElementById('recoBadge');
    const dd = document.getElementById('recoDD');
    const peak = document.getElementById('recoPeak');
    const price = document.getElementById('recoPrice');
    const drop = document.getElementById('recoDrop');
    const buyPx = document.getElementById('recoBuyPx');
    const gap = document.getElementById('recoGap');
    const wait = document.getElementById('recoWait');
    const med = document.getElementById('recoMed');
    const sr = document.getElementById('recoSR');

    if (!r || !best) {
        badge.textContent = '—';
        badge.className = 'text-center rounded-lg p-6 font-semibold';
        dd.textContent = peak.textContent = price.textContent = drop.textContent = buyPx.textContent = gap.textContent = wait.textContent = med.textContent = sr.textContent = '—';
        return;
    }

    const isBuy = r.action === 'buy';
    badge.textContent = isBuy ? `BUY NOW (target +${(targetPct*100).toFixed(1)}%)` : 'WAIT';
    badge.className = `text-center rounded-lg p-6 font-semibold ${isBuy ? 'bg-green-500 text-white' : 'bg-yellow-500 text-white'}`;

    dd.textContent   = r.current_drawdown_pct!=null ? (r.current_drawdown_pct*100).toFixed(1)+'%' : '—';
    peak.textContent = r.peak_price!=null ? moneyPrec(r.peak_price, sym) : '—';
    price.textContent= r.current_price!=null ? moneyPrec(r.current_price, sym) : '—';

    drop.textContent = r.recommended_drop_pct!=null ? (r.recommended_drop_pct*100).toFixed(1)+'%' : '—';
    buyPx.textContent= r.target_buy_price!=null ? moneyPrec(r.target_buy_price, sym) : '—';
    gap.textContent  = r.distance_to_signal_pct!=null ? (r.distance_to_signal_pct*100).toFixed(1)+'%' : '—';

    wait.textContent = r.expected_wait_days!=null ? (+r.expected_wait_days).toFixed(1)+'d' : '—';
    med.textContent  = r.expected_median_days_to_target!=null ? (+r.expected_median_days_to_target).toFixed(1)+'d' : '—';
    sr.textContent   = r.success_rate!=null ? (r.success_rate*100).toFixed(1)+'%' : '—';
    }

    async function loadAll() {

      const cfg = await loadCoinConfig();
        if (!document.getElementById('symbol').options.length) {
        populateSymbolSelect(cfg);
      }

      const symbol = document.getElementById('symbol').value;
      const applyDefaults = document.getElementById('applyDefaults').checked;
      const agg = document.getElementById('agg').value;
      const start = document.getElementById('start').value || '';
      const end = document.getElementById('end').value || '';
      const sma = parseList(document.getElementById('sma').value);
      const ema = parseList(document.getElementById('ema').value);
      let rsi = Number(document.getElementById('rsi').value || 14);
      let macdFast = 12, macdSlow = 26, macdSignal = 9;
      const bbp = Number(document.getElementById('bbp').value || 20);
      const bbs = Number(document.getElementById('bbs').value || 2.0);
      const showPivots = document.getElementById('showPivots').checked;
      const odTarget = Number(document.getElementById('odTarget').value || 5) / 100.0;
      const odMin    = Number(document.getElementById('odMin').value || 5) / 100.0;
      const odMax    = Number(document.getElementById('odMax').value || 40) / 100.0;
      const odStep   = Number(document.getElementById('odStep').value || 1) / 100.0;
      const odLook   = Number(document.getElementById('odLook').value || 60);
      const odScore = document.getElementById('odScore').value;
      const recoPeakWin = Number(document.getElementById('recoPeakWin').value || 180);

      // if Apply Defaults, override with coin settings (if present)
      if (applyDefaults) {
        const coin = cfg.coins?.[symbol];
        if (coin?.rsi_period) rsi = Number(coin.rsi_period);
        if (coin?.macd_short_window)  macdFast   = Number(coin.macd_short_window);
        if (coin?.macd_long_window)   macdSlow   = Number(coin.macd_long_window);
        if (coin?.macd_signal_window) macdSignal = Number(coin.macd_signal_window);
      }

      // CSV link
      document.getElementById('csvBtn').href = buildURL('/api/lt/export.csv', { symbol, agg, start, end });

      const busy = document.getElementById('busy');
      busy.classList.remove('hidden');

      try {
        const indURL = buildURL('/api/lt/indicators', {
          symbol, agg, start, end,
          rsi_period: rsi,
          bollinger_period: bbp, bollinger_std: bbs,
          macd_fast: macdFast, macd_slow: macdSlow, macd_signal: macdSignal,
          ...(sma.length ? { sma } : {}),
          ...(ema.length ? { ema } : {}),
        });
        const seURL  = buildURL('/api/lt/seasonality', { symbol, start, end, agg: '1h' });

        // Build reco URL (avoid 'raw' noise)
        const recoURL = buildURL('/api/lt/recommendation', {
            symbol, start, end, agg: (agg === 'raw' ? '1h' : agg),
            target_pct: odTarget,
            drop_min: odMin, drop_max: odMax, drop_step: odStep,
            lookahead_days: odLook,
            score_mode: odScore,
            peak_lookback_days: recoPeakWin
        });

        // Drawdown params
        const ddMin = Number(document.getElementById('ddMin').value || 10) / 100.0; // to fraction
        const ddTol = Number(document.getElementById('ddTol').value || 0) / 100.0;
        const ddLook = Number(document.getElementById('ddLook').value || 60);
        const ddOver = Number(document.getElementById('ddOver').value || 14);

        const ddURL  = buildURL('/api/lt/drawdowns', {
        symbol, start, end, agg: (agg === 'raw' ? '1h' : agg), // avoid raw noise
        min_drop: ddMin,
        recovery_tolerance: ddTol,
        lookahead_days: ddLook,
        overshoot_window_days: ddOver
        });

        // Optimal drop URL
        const odURL  = buildURL('/api/lt/optimal_drop', {
        symbol, start, end, agg: (agg === 'raw' ? '1h' : agg),
        target_pct: odTarget,
        drop_min: odMin, drop_max: odMax, drop_step: odStep,
        lookahead_days: odLook,
        score_mode: odScore
        });

        // Fetch all
        const [indRes, seRes, ddRes, odRes, recoRes] = await Promise.all([
            fetch(indURL), fetch(seURL), fetch(ddURL), fetch(odURL), fetch(recoURL)
        ]);
        if (!indRes.ok) throw new Error('Indicators request failed');
        if (!seRes.ok) throw new Error('Seasonality request failed');
        if (!ddRes.ok) throw new Error('Drawdowns request failed');
        if (!odRes.ok) throw new Error('Optimal drop request failed');
        if (!recoRes.ok) throw new Error('Recommendation request failed');

        const odJson = await odRes.json();
        const grid = odJson.grid || [];
        const best = odJson.best || null;

        const indJson = await indRes.json();
        const rows = indJson.data || [];
        const labels = rows.map(r => r.timestamp?.slice(0,19).replace('T',' ') ?? '');
        const price  = rows.map(r => negateNull(r.price));

        // datasets
        const p = palette();
        const datasets = [
        { label: 'Price', data: price, borderWidth: 2, borderColor: p.price, backgroundColor: 'transparent' },
        ];

        const recoJson = await recoRes.json();
        document.getElementById('recoParamsNote').textContent =
            `peak window ${recoPeakWin}d · target ${(odTarget*100).toFixed(1)}% · score ${odScore.replaceAll('_',' ')}`;

        // add SMAs
        let si = 0;
        sma.forEach(w => {
        const key = `SMA_${w}`;
        if (rows[0] && key in rows[0]) {
            datasets.push({
            label: key,
            data: rows.map(r => negateNull(r[key])),
            borderWidth: 1.5,
            borderDash: [4,3],
            borderColor: p.sma[si++ % p.sma.length],
            backgroundColor: 'transparent'
            });
        }
        });

        // add EMAs
        let ei = 0;
        ema.forEach(w => {
        const key = `EMA_${w}`;
        if (rows[0] && key in rows[0]) {
            datasets.push({
            label: key,
            data: rows.map(r => negateNull(r[key])),
            borderWidth: 1.5,
            borderColor: p.ema[ei++ % p.ema.length],
            backgroundColor: 'transparent'
            });
        }
        });

        // Bollinger
        if (rows[0] && 'BB_UPPER' in rows[0]) {
        datasets.push({ label: 'BB Upper', data: rows.map(r => negateNull(r.BB_UPPER)), borderWidth: 1, borderColor: p.bb.upper, backgroundColor: 'transparent' });
        datasets.push({ label: 'BB Mid',   data: rows.map(r => negateNull(r.BB_MID)),   borderWidth: 1, borderDash: [3,3], borderColor: p.bb.mid,   backgroundColor: 'transparent' });
        datasets.push({ label: 'BB Lower', data: rows.map(r => negateNull(r.BB_LOWER)), borderWidth: 1, borderColor: p.bb.lower, backgroundColor: 'transparent' });
        }

        // Pivots (render as sparse series)
        if (showPivots && rows[0] && 'PIVOT_HIGH' in rows[0]) {
          const highs = rows.map((r,i) => r.PIVOT_HIGH ? price[i] : null);
          const lows  = rows.map((r,i) => r.PIVOT_LOW  ? price[i] : null);
          datasets.push({ label: 'Pivot High', data: highs, showLine: false, pointRadius: 3 });
          datasets.push({ label: 'Pivot Low',  data: lows,  showLine: false, pointRadius: 3 });
        }

        // ----- Drawdowns -----
        const ddJson = await ddRes.json();
        const events = ddJson.events || [];
        const summary = ddJson.summary || {};

        // KPIs + params note
        renderDrawdownKPIs(summary);
        document.getElementById('ddParamsNote').textContent =
        `min drop ${(ddMin*100).toFixed(1)}%, tolerance ${(ddTol*100).toFixed(1)}%, lookahead ${ddLook}d, overshoot ${ddOver}d`;

        // Table
        renderDrawdownTable(events);

        // Marker overlays
        const ddMarkerSets = buildDrawdownMarkerDatasets(labels, price, events);
        ddMarkerSets.forEach(ds => datasets.push(ds));
        priceChart = makeLine(document.getElementById('priceChart'), 'Price', labels, datasets, 'Price');

        // MACD
        const macd = rows.map(r => negateNull(r.MACD));
        const sig  = rows.map(r => negateNull(r.MACD_SIGNAL));
        const hist = rows.map(r => negateNull(r.MACD_HIST));
        macdChart = makeLine(document.getElementById('macdChart'), 'MACD', labels, [
        { label: 'MACD', data: macd, borderWidth: 1.5, borderColor: p.macd.macd },
        { label: 'Signal', data: sig, borderWidth: 1.2, borderDash: [4,3], borderColor: p.macd.signal },
        { label: 'Histogram', data: hist, type: 'bar', backgroundColor: p.macd.hist, borderColor: p.macd.hist }
        ], 'MACD');

        // RSI
        const rsiSeries = rows.map(r => negateNull(r.RSI));
        rsiChart = makeLine(document.getElementById('rsiChart'), 'RSI', labels, [
        { label: 'RSI', data: rsiSeries, borderWidth: 1.5, borderColor: p.rsi }
        ], 'RSI');

        // KPIs
        updateKPIs(rows);
        renderOptimalKPIs(best);
        renderOptimalChart(grid);
        renderRecommendation(recoJson, odTarget, symbol);

        // Seasonality heatmaps
        const seJson = await seRes.json();
        const dow = seJson.day_of_week || {};
        const hour = seJson.hour_of_day || {};
        const dowLabels = ['0','1','2','3','4','5','6'].map(d => ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][Number(d)] ?? d);
        const hourLabels = Array.from({length:12}, (_,i)=>String(i*2).padStart(2,'0')+':00'); // compact view
        // Normalize dictionaries to those labels
        const dowMap = {}; ['0','1','2','3','4','5','6'].forEach((d,i)=>{ dowMap[dowLabels[i]] = dow[d] ?? 0; });
        const hourMap = {}; for (let h=0; h<24; h++) hourMap[String(h).padStart(2,'0')+':00'] = hour[String(h)] ?? 0;

        renderHeatmap(document.getElementById('dow'), dowMap, dowLabels, -0.15, 0.15);
        renderHeatmap(document.getElementById('hour'), hourMap, Object.keys(hourMap), -0.15, 0.15);

        // Seasonality KPI: best hour/day
        const bestDay = Object.entries(dowMap).sort((a,b)=>b[1]-a[1])[0];
        const bestHour = Object.entries(hourMap).sort((a,b)=>b[1]-a[1])[0];
        document.getElementById('kpiSeason').textContent =
          `${bestDay ? bestDay[0] : '—'} @ ${bestHour ? bestHour[0] : '—'}`;

      } catch (err) {
        console.error(err);
        alert('Oops, failed to load data. Check console.');
      } finally {
        busy.classList.add('hidden');
      }
    }

    document.getElementById('loadBtn').onclick = loadAll;

    // Auto-set Start = 1 year ago (nice default)
    (function preset(){
      const d = new Date();
      const past = new Date(d); past.setFullYear(d.getFullYear() - 1);
      document.getElementById('start').valueAsDate = past;
    })();

    // First load on open
    window.addEventListener('DOMContentLoaded', loadAll);
  </script>
</body>
</html>
